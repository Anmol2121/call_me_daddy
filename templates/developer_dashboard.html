{% extends "base.html" %}
{% block title %}Developer Dashboard{% endblock %}
{% block header %}Developer Dashboard{% endblock %}

{% block actions %}
<div class="d-flex gap-2">
    <a href="{{ url_for('create_school') }}" class="btn btn-primary">
        <i class="bi bi-plus-circle me-1"></i> New School
    </a>
    <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#systemReportModal">
        <i class="bi bi-download me-1"></i> System Report
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Quick Stats Row -->
<div class="row mb-4">
    <div class="col-6 col-md-3 mb-3">
        <div class="card stat-card bg-primary text-white h-100">
            <div class="card-body d-flex flex-column justify-content-between">
                <div>
                    <h6 class="card-title">Schools</h6>
                    <h2 class="mb-0">{{ stats.total_schools }}</h2>
                </div>
                <div class="mt-2 small">{{ active_schools_count }} active</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3 mb-3">
        <div class="card stat-card bg-success text-white h-100">
            <div class="card-body d-flex flex-column justify-content-between">
                <div>
                    <h6 class="card-title">Admins</h6>
                    <h2 class="mb-0">{{ stats.total_admins }}</h2>
                </div>
                <div class="mt-2 small">{{ active_admins_count }} active</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3 mb-3">
        <div class="card stat-card bg-info text-white h-100">
            <div class="card-body d-flex flex-column justify-content-between">
                <div>
                    <h6 class="card-title">Teachers</h6>
                    <h2 class="mb-0">{{ stats.total_teachers }}</h2>
                </div>
                <div class="mt-2 small">{{ active_teachers_count }} active</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3 mb-3">
        <div class="card stat-card bg-warning text-white h-100">
            <div class="card-body d-flex flex-column justify-content-between">
                <div>
                    <h6 class="card-title">Students</h6>
                    <h2 class="mb-0">{{ stats.total_students }}</h2>
                </div>
                <div class="mt-2 small">{{ enrolled_students_count }} enrolled</div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Recent Schools -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Recent Schools</h6>
                <a href="{{ url_for('manage_schools') }}" class="btn btn-sm btn-link">View All</a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>School</th>
                                <th>Admin</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Students</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for school in recent_schools %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-circle avatar-primary me-2">
                                            <i class="bi bi-building"></i>
                                        </div>
                                        <div>
                                            <div class="fw-semibold">{{ school.name }}</div>
                                            <small class="text-muted">{{ school.code }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% set admin = school.users|selectattr('role', 'equalto', 'admin')|first %}
                                    {% if admin %}
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-circle avatar-success me-2" style="width: 32px; height: 32px;">
                                            {{ admin.full_name[0]|upper }}
                                        </div>
                                        <div>
                                            <div class="small fw-semibold">{{ admin.full_name }}</div>
                                            <div class="x-small text-muted">{{ admin.email }}</div>
                                        </div>
                                    </div>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if school.is_active %}
                                    <span class="badge bg-success">Active</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Suspended</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="small">{{ school.created_at.strftime('%b %d, %Y') }}</div>
                                    <small class="text-muted">{{ school.created_at.strftime('%I:%M %p').lstrip('0') }}</small>
                                </td>
                                <td>
                                    <div class="text-center">
                                        <div class="fw-medium">{{ school.students|length }}</div>
                                    </div>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('school_details', school_id=school.id) }}" class="btn btn-outline-secondary" title="View">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <a href="{{ url_for('manage_schools') }}" class="btn btn-outline-primary" title="Manage">
                                            <i class="bi bi-gear"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- System Activity (scrollable list) -->
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">System Activity</h6>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary active" onclick="filterActivity('all')">All</button>
                    <button class="btn btn-outline-secondary" onclick="filterActivity('school')">Schools</button>
                    <button class="btn btn-outline-secondary" onclick="filterActivity('user')">Users</button>
                    <button class="btn btn-outline-secondary" onclick="filterActivity('enrollment')">Enrollments</button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush" id="activityTimeline" style="max-height: 400px; overflow-y: auto;">
                    {% for activity in recent_activity %}
                    <div class="list-group-item activity-{{ activity.type }} p-3">
                        <div class="d-flex align-items-start">
                            <div class="flex-shrink-0 me-3">
                                <div class="avatar-circle avatar-{{ activity.color }}">
                                    <i class="bi bi-{{ activity.icon }} fs-5"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-1 fw-semibold">{{ activity.title }}</h6>
                                    <small class="text-muted">
                                        {% if activity.time %}
                                            {{ activity.time }}
                                        {% else %}
                                            {{ activity.created_at.strftime('%I:%M %p').lstrip('0') }}
                                        {% endif %}
                                    </small>
                                </div>
                                <p class="mb-1 text-muted small">{{ activity.description }}</p>
                                <div class="d-flex align-items-center">
                                    <small class="text-muted">
                                        <i class="bi bi-calendar me-1"></i>
                                        {% if activity.date %}
                                            {{ activity.date }}
                                        {% else %}
                                            {{ activity.created_at.strftime('%B %d, %Y') }}
                                        {% endif %}
                                    </small>
                                    <span class="badge bg-light text-dark ms-2">{{ activity.type|title }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <i class="bi bi-activity"></i>
                        <h5>No Activity Yet</h5>
                        <p>System activity will appear here.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column: System Status and Quick Actions -->
    <div class="col-lg-4 mb-4">
        <!-- System Status Card -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">System Status</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="small">Database</span>
                        <span class="small fw-medium">
                            {% if db_status.connected %}
                            <span class="text-success"><i class="bi bi-check-circle-fill"></i> Connected</span>
                            {% else %}
                            <span class="text-danger"><i class="bi bi-x-circle-fill"></i> Disconnected</span>
                            {% endif %}
                        </span>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-{% if db_status.connected %}success{% else %}danger{% endif %}" style="width: 100%"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="small">Health</span>
                        <span class="small fw-medium text-{{ system_health.color }}">{{ system_health.status|title }}</span>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-{{ system_health.color }}" style="width: {{ system_health.score }}%"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="small">Storage</span>
                        <span class="small fw-medium">{{ storage_usage.percentage }}%</span>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-{{ storage_usage.color }}" style="width: {{ storage_usage.percentage }}%"></div>
                    </div>
                    <div class="small text-muted mt-1">{{ storage_usage.used_gb }} / {{ storage_usage.total_gb }} GB</div>
                </div>
                <div>
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="small">Active Sessions</span>
                        <span class="small fw-medium">{{ active_sessions_count }}</span>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar" style="width: {{ active_sessions_percentage }}%; background-color: #9b59b6;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Statistics -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">Quick Stats (This Month)</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="fw-medium text-primary">{{ stats_by_month.new_schools }}</div>
                        <small class="text-muted">New Schools</small>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="fw-medium text-success">{{ stats_by_month.new_students }}</div>
                        <small class="text-muted">New Students</small>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="fw-medium text-info">{{ stats_by_month.new_teachers }}</div>
                        <small class="text-muted">New Teachers</small>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="fw-medium text-warning">{{ stats_by_month.new_classes }}</div>
                        <small class="text-muted">New Classes</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">Quick Actions</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('create_school') }}" class="btn btn-outline-primary">
                        <i class="bi bi-plus-circle me-2"></i> Create New School
                    </a>
                    <button class="btn btn-outline-secondary" onclick="runSystemCheck()">
                        <i class="bi bi-shield-check me-2"></i> Run System Check
                    </button>
                    <button class="btn btn-outline-secondary" onclick="clearCache()">
                        <i class="bi bi-trash me-2"></i> Clear Cache
                    </button>
                    <button class="btn btn-outline-secondary" onclick="showBackupDialog()">
                        <i class="bi bi-cloud-arrow-up me-2"></i> Backup Database
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Performance (hidden on small screens, optional) -->
<div class="row mt-4 d-none d-md-block">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">System Performance</h6>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary active" data-period="7d">7 Days</button>
                    <button class="btn btn-outline-secondary" data-period="30d">30 Days</button>
                    <button class="btn btn-outline-secondary" data-period="90d">90 Days</button>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="text-center">
                            <div class="display-6 fw-bold text-primary">{{ performance_metrics.uptime }}%</div>
                            <div class="text-muted">Uptime</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="text-center">
                            <div class="display-6 fw-bold text-success">{{ performance_metrics.response_time }}ms</div>
                            <div class="text-muted">Response</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="text-center">
                            <div class="display-6 fw-bold text-info">{{ performance_metrics.active_users }}</div>
                            <div class="text-muted">Daily Users</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="text-center">
                            <div class="display-6 fw-bold text-warning">{{ performance_metrics.error_rate }}%</div>
                            <div class="text-muted">Error Rate</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Report Modal (unchanged) -->
<div class="modal fade" id="systemReportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">System Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Statistics Summary</h6>
                        <ul class="list-unstyled">
                            <li class="mb-2"><i class="bi bi-building text-primary me-2"></i>Schools: {{ stats.total_schools }} total</li>
                            <li class="mb-2"><i class="bi bi-person-badge text-success me-2"></i>Admins: {{ stats.total_admins }}</li>
                            <li class="mb-2"><i class="bi bi-people text-info me-2"></i>Teachers: {{ stats.total_teachers }}</li>
                            <li class="mb-2"><i class="bi bi-mortarboard text-warning me-2"></i>Students: {{ stats.total_students }}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>System Status</h6>
                        <ul class="list-unstyled">
                            <li class="mb-2"><i class="bi bi-database text-success me-2"></i>Database: {{ 'Connected' if db_status.connected else 'Disconnected' }}</li>
                            <li class="mb-2"><i class="bi bi-heart-pulse text-success me-2"></i>Health: {{ system_health.status|title }}</li>
                            <li class="mb-2"><i class="bi bi-hdd text-info me-2"></i>Storage: {{ storage_usage.percentage }}% used</li>
                            <li class="mb-2"><i class="bi bi-people text-primary me-2"></i>Sessions: {{ active_sessions_count }} active</li>
                        </ul>
                    </div>
                </div>
                <div class="mt-3">
                    <h6>Report Generated</h6>
                    <p class="text-muted small">{{ report_date }}</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="exportReport()"><i class="bi bi-download me-1"></i> Export PDF</button>
            </div>
        </div>
    </div>
</div>

<script>
    function filterActivity(type) {
        const items = document.querySelectorAll('.list-group-item');
        items.forEach(item => {
            if (type === 'all' || item.classList.contains('activity-' + type)) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
        document.querySelectorAll('[onclick^="filterActivity"]').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    }

    function exportReport() {
        alert('System report exported successfully!');
    }

    function runSystemCheck() {
        alert('System check completed: All systems operational.');
    }

    function clearCache() {
        if (confirm('Clear system cache?')) alert('Cache cleared.');
    }

    function showBackupDialog() {
        alert('Backup started. You will be notified when complete.');
    }
</script>
{% endblock %}
