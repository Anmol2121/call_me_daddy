{% extends "base.html" %}
{% block title %}Fee Reports{% endblock %}
{% block header %}Fee Reports{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('admin_dashboard') }}">Dashboard</a></li>
<li class="breadcrumb-item active">Fee Reports</li>
{% endblock %}

{% block actions %}
<button onclick="printReport()" class="btn btn-outline-primary btn-sm me-2">
    <i class="fas fa-print me-1"></i> Print
</button>
<button onclick="exportReport()" class="btn btn-outline-success btn-sm">
    <i class="fas fa-download me-1"></i> Export
</button>
{% endblock %}

{% block content %}
<!-- Date Filter -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Filter Report</h5>
    </div>
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Start Date</label>
                <input type="date" name="start_date" class="form-control" 
                       value="{{ start_date.strftime('%Y-%m-%d') }}">
            </div>
            
            <div class="col-md-4">
                <label class="form-label">End Date</label>
                <input type="date" name="end_date" class="form-control" 
                       value="{{ end_date.strftime('%Y-%m-%d') }}">
            </div>
            
            <div class="col-md-4 d-flex align-items-end">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="fas fa-filter me-1"></i> Apply Filter
                </button>
                <a href="{{ url_for('fee_reports') }}" class="btn btn-secondary">
                    Reset
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stat-card bg-primary text-white">
            <div class="stat-icon">
                <i class="fas fa-money-bill-wave"></i>
            </div>
            <div>
                <h2 class="stat-number">₹{{ total_fees|round|int }}</h2>
                <div class="stat-label">Total Fees</div>
                <small>{{ all_student_fees|length }} Records</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card bg-success text-white">
            <div class="stat-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div>
                <h2 class="stat-number">₹{{ total_paid|round|int }}</h2>
                <div class="stat-label">Total Collected</div>
                <small>
                    {% if total_fees > 0 %}
                        {{ (total_paid/total_fees*100)|round(1) }}% Collected
                    {% else %}
                        0% Collected
                    {% endif %}
                </small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card bg-warning text-white">
            <div class="stat-icon">
                <i class="fas fa-clock"></i>
            </div>
            <div>
                <h2 class="stat-number">₹{{ total_due|round|int }}</h2>
                <div class="stat-label">Total Due</div>
                <small>{{ pending_fees_count }} Pending Records</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card bg-danger text-white">
            <div class="stat-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div>
                <h2 class="stat-number">₹{{ total_overdue|round|int }}</h2>
                <div class="stat-label">Total Overdue</div>
                <small>{{ overdue_fees_count }} Overdue Records</small>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Summary -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">Fee Breakdown</h5>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span>Total Fee Amount</span>
                        <strong class="text-primary">₹{{ total_fees|round|int }}</strong>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span>Total Discounts</span>
                        <strong class="text-success">-₹{{ total_discount|round|int }}</strong>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span>Total Fines</span>
                        <strong class="text-danger">+₹{{ total_fine|round|int }}</strong>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span>Net Payable</span>
                        <strong>₹{{ (total_fees - total_discount + total_fine)|round|int }}</strong>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span>Total Paid</span>
                        <strong class="text-success">₹{{ total_paid|round|int }}</strong>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span>Total Due</span>
                        <strong class="text-danger">₹{{ total_due|round|int }}</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">Collection Progress</h5>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <div class="d-flex justify-content-between mb-1">
                        <span>Overall Collection Rate</span>
                        <span>
                            {% if total_fees > 0 %}
                                {{ (total_paid/total_fees*100)|round(1) }}%
                            {% else %}
                                0%
                            {% endif %}
                        </span>
                    </div>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar bg-success" role="progressbar" 
                             style="width: {% if total_fees > 0 %}{{ (total_paid/total_fees*100)|round(1) }}%{% else %}0%{% endif %}">
                            {% if total_fees > 0 %}
                                {{ (total_paid/total_fees*100)|round(1) }}%
                            {% else %}
                                0%
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-6">
                        <div class="p-3 bg-success-light rounded mb-2">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                <div>
                                    <div class="small text-muted">Paid Amount</div>
                                    <div class="h5 mb-0">₹{{ total_paid|round|int }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3 bg-warning-light rounded mb-2">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-clock text-warning me-2"></i>
                                <div>
                                    <div class="small text-muted">Pending Amount</div>
                                    <div class="h5 mb-0">₹{{ total_due|round|int }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Transactions -->
<div class="card mb-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Recent Transactions</h5>
            <span class="badge bg-primary">{{ transactions|length }} transactions</span>
        </div>
    </div>
    <div class="card-body">
        {% if transactions %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Student</th>
                        <th>Fee Type</th>
                        <th>Amount</th>
                        <th>Method</th>
                        <th>Receipt No.</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for transaction in transactions %}
                    <tr>
                        <td>{{ transaction.transaction_date.strftime('%d %b %Y') }}</td>
                        <td>
                            {{ transaction.student.first_name }} {{ transaction.student.last_name }}
                            <div class="small text-muted">{{ transaction.student.student_id }}</div>
                        </td>
                        <td>
                            {% if transaction.student_fee %}
                                {{ transaction.student_fee.fee_structure.name }}
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td class="text-success">₹{{ transaction.amount }}</td>
                        <td>
                            <span class="badge bg-info">{{ transaction.payment_method|title }}</span>
                        </td>
                        <td>
                            <small class="text-muted">{{ transaction.receipt_number }}</small>
                        </td>
                        <td>
                            {% if transaction.status == 'success' %}
                            <span class="badge bg-success">Success</span>
                            {% else %}
                            <span class="badge bg-warning">{{ transaction.status|title }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-exchange-alt fa-3x text-muted mb-3"></i>
            <p class="text-muted">No transactions found for the selected period</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Session Information -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">Report Information</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <p><strong>Report Period:</strong></p>
                <p>{{ start_date.strftime('%d %b %Y') }} to {{ end_date.strftime('%d %b %Y') }}</p>
            </div>
            <div class="col-md-4">
                <p><strong>Academic Session:</strong></p>
                <p>{{ view_session.name }}</p>
            </div>
            <div class="col-md-4">
                <p><strong>Generated On:</strong></p>
                <p>{{ date.strftime('%d %b %Y %H:%M') }}</p>
            </div>
        </div>
        
        <div class="mt-3 text-end">
            <small class="text-muted ms-3">Last updated: {{ date.strftime('%d %b %Y %H:%M') }}</small>
        </div>
    </div>
</div>

<style>
.stat-card {
    border-radius: 12px;
    padding: 1.5rem;
    color: white;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.stat-card .stat-icon {
    font-size: 2rem;
    margin-bottom: 1rem;
    opacity: 0.9;
}

.stat-card .stat-number {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
}

.stat-card .stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
    margin-bottom: 0.25rem;
}

.bg-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; }
.bg-success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%) !important; }
.bg-warning { background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%) !important; }
.bg-danger { background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%) !important; }

.bg-success-light { background-color: rgba(40, 167, 69, 0.1) !important; }
.bg-warning-light { background-color: rgba(255, 193, 7, 0.1) !important; }

.progress {
    height: 20px;
    border-radius: 10px;
}

.progress-bar {
    border-radius: 10px;
}
</style>

<script>
function printReport() {
    window.print();
}

function exportReport() {
    // Get current filter parameters
    const params = new URLSearchParams(window.location.search);
    
    // Create export URL
    const exportUrl = `/admin/fees/export-reports?${params.toString()}`;
    
    // Create a temporary link to trigger download
    const link = document.createElement('a');
    link.href = exportUrl;
    link.target = '_blank';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

document.addEventListener('DOMContentLoaded', function() {
    // Set default dates if not set
    const startDateInput = document.querySelector('input[name="start_date"]');
    const endDateInput = document.querySelector('input[name="end_date"]');
    
    if (!startDateInput.value) {
        const firstDay = new Date();
        firstDay.setDate(1);
        startDateInput.value = firstDay.toISOString().split('T')[0];
    }
    
    if (!endDateInput.value) {
        const today = new Date().toISOString().split('T')[0];
        endDateInput.value = today;
    }
});
</script>
{% endblock %}