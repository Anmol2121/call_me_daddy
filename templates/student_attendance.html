{% extends "base.html" %}

{% block title %}Attendance Records · Premium Student Portal{% endblock %}
{% block header %}Attendance Records{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Home</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('student_dashboard') }}">Dashboard</a></li>
<li class="breadcrumb-item active">Attendance</li>
{% endblock %}

{% block actions %}
<div class="d-flex gap-2">
    <button onclick="window.print()" class="btn btn-outline-primary btn-sm px-3">
        <i class="fas fa-print me-2"></i>Print
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Stats Cards -->
<div class="row mb-4" data-aos="fade-up">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="glass-card h-100">
            <div class="d-flex align-items-center p-3">
                <div class="rounded-circle bg-success bg-opacity-10 text-success d-flex align-items-center justify-content-center me-3" style="width: 60px; height: 60px;">
                    <i class="fas fa-user-check fa-2x"></i>
                </div>
                <div>
                    <h6 class="text-muted mb-1">Present Days</h6>
                    <h3 class="mb-0 fw-bold text-dark">{{ attendance_stats.present_days }}/{{ attendance_stats.total_days }}</h3>
                    <small class="text-muted">{{ attendance_stats.current_month }}</small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="glass-card h-100">
            <div class="d-flex align-items-center p-3">
                <div class="rounded-circle {% if attendance_stats.attendance_percentage >= 80 %}bg-success{% elif attendance_stats.attendance_percentage >= 60 %}bg-warning{% else %}bg-danger{% endif %} bg-opacity-10 {% if attendance_stats.attendance_percentage >= 80 %}text-success{% elif attendance_stats.attendance_percentage >= 60 %}text-warning{% else %}text-danger{% endif %} d-flex align-items-center justify-content-center me-3" style="width: 60px; height: 60px;">
                    <i class="fas fa-chart-line fa-2x"></i>
                </div>
                <div>
                    <h6 class="text-muted mb-1">Attendance Rate</h6>
                    <h3 class="mb-0 fw-bold text-dark">{{ attendance_stats.attendance_percentage }}%</h3>
                    <small class="{% if attendance_stats.attendance_percentage >= 80 %}text-success{% elif attendance_stats.attendance_percentage >= 60 %}text-warning{% else %}text-danger{% endif %}">
                        {% if attendance_stats.attendance_percentage >= 80 %}Excellent{% elif attendance_stats.attendance_percentage >= 60 %}Good{% else %}Needs Improvement{% endif %}
                    </small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="glass-card h-100">
            <div class="d-flex align-items-center p-3">
                <div class="rounded-circle bg-danger bg-opacity-10 text-danger d-flex align-items-center justify-content-center me-3" style="width: 60px; height: 60px;">
                    <i class="fas fa-user-times fa-2x"></i>
                </div>
                <div>
                    <h6 class="text-muted mb-1">Absent Days</h6>
                    <h3 class="mb-0 fw-bold text-dark">{{ attendance_stats.absent_days }}</h3>
                    <small class="text-muted">This month</small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="glass-card h-100">
            <div class="d-flex align-items-center p-3">
                <div class="rounded-circle bg-info bg-opacity-10 text-info d-flex align-items-center justify-content-center me-3" style="width: 60px; height: 60px;">
                    <i class="fas fa-clock fa-2x"></i>
                </div>
                <div>
                    <h6 class="text-muted mb-1">Late Arrivals</h6>
                    <h3 class="mb-0 fw-bold text-dark">{{ attendance_stats.late_days }}</h3>
                    <small class="text-muted">This month</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Class Average Comparison -->
<div class="row mb-4" data-aos="fade-up">
    <div class="col-12">
        <div class="glass-card">
            <div class="alert alert-info border-0 mb-0" style="background: linear-gradient(135deg, rgba(14,165,233,0.1) 0%, rgba(14,165,233,0.05) 100%);">
                <div class="d-flex align-items-center">
                    <i class="fas fa-chart-line fa-2x text-info me-3"></i>
                    <div>
                        <h6 class="mb-1">Your Performance vs Class Average</h6>
                        <div class="d-flex gap-4">
                            <div>
                                <span class="text-muted">Your attendance:</span>
                                <strong class="ms-2 {% if attendance_stats.attendance_percentage >= 80 %}text-success{% elif attendance_stats.attendance_percentage >= 60 %}text-warning{% else %}text-danger{% endif %}">
                                    {{ attendance_stats.attendance_percentage }}%
                                </strong>
                            </div>
                            <div>
                                <span class="text-muted">Class average:</span>
                                <strong class="ms-2">{{ class_avg|round(1) }}%</strong>
                            </div>
                        </div>
                        <div class="progress mt-2" style="height: 6px;">
                            <div class="progress-bar bg-info" style="width: {{ class_avg }}%"></div>
                            <div class="progress-bar {% if attendance_stats.attendance_percentage >= class_avg %}bg-success{% else %}bg-warning{% endif %}" style="width: {{ attendance_stats.attendance_percentage }}%; margin-left: -{{ attendance_stats.attendance_percentage }}%;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Attendance Trends Chart -->
<div class="row mb-4" data-aos="fade-up">
    <div class="col-12">
        <div class="glass-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h4 class="mb-0">
                        <i class="fas fa-chart-line me-2 text-primary"></i>
                        Attendance Trends
                    </h4>
                    <small class="text-muted">Last 6 months</small>
                </div>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-primary" onclick="changeChartPeriod('6months')">6M</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="changeChartPeriod('1year')">1Y</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="changeChartPeriod('all')">All</button>
                </div>
            </div>
            <div style="height: 250px;">
                <canvas id="attendanceTrendChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Calendar View Toggle -->
<div class="row mb-4" data-aos="fade-up">
    <div class="col-12">
        <div class="glass-card">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-alt me-2 text-primary"></i>
                    Calendar View
                </h5>
                <button class="btn btn-outline-primary btn-sm" id="toggleCalendar">
                    <i class="fas fa-calendar-plus me-2"></i>Show Calendar
                </button>
            </div>
            <div id="calendarContainer" style="display: none;" class="mt-4">
                <div id="calendar"></div>
            </div>
        </div>
    </div>
</div>

<!-- Attendance Records Table -->
<div class="glass-card mb-4" data-aos="fade-up">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="mb-0">
                <i class="fas fa-history me-2 text-primary"></i>
                Attendance History
            </h4>
            <small class="text-muted">{{ start_date.strftime('%b %d, %Y') }} to {{ end_date.strftime('%b %d, %Y') }}</small>
        </div>
        <div class="d-flex gap-2">
            <input type="month" class="form-control form-control-sm" id="monthFilter" value="{{ date.today().strftime('%Y-%m') }}" onchange="filterByMonth(this.value)">
            <button class="btn btn-outline-dark btn-sm" onclick="resetFilter()">
                <i class="fas fa-sync me-1"></i>Reset
            </button>
        </div>
    </div>

    {% if attendance_records %}
    <div class="table-responsive">
        <table class="premium-table" id="attendanceTable">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Day</th>
                    <th>Status</th>
                    <th>Class</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody>
                {% for record in attendance_records %}
                <tr data-date="{{ record.date.strftime('%Y-%m') }}">
                    <td>
                        <div class="fw-bold">{{ record.date.strftime('%d %b %Y') }}</div>
                        <small class="text-muted">Week {{ ((record.date.day - 1)//7) + 1 }}</small>
                    </td>
                    <td><span class="badge bg-light text-dark border">{{ record.date.strftime('%A') }}</span></td>
                    <td>
                        {% if record.status == 'present' %}
                        <span class="status-badge status-paid">
                            <i class="fas fa-check-circle"></i> Present
                        </span>
                        {% elif record.status == 'absent' %}
                        <span class="status-badge status-overdue">
                            <i class="fas fa-times-circle"></i> Absent
                        </span>
                        {% elif record.status == 'late' %}
                        <span class="status-badge status-pending">
                            <i class="fas fa-clock"></i> Late
                        </span>
                        {% elif record.status == 'half_day' %}
                        <span class="status-badge bg-info bg-opacity-10 text-info border border-info">
                            <i class="fas fa-hourglass-half"></i> Half Day
                        </span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="fw-bold">{{ record.class_.name }}</div>
                        <small class="text-muted">{{ record.class_.code }}</small>
                    </td>
                    <td>{% if record.notes %}{{ record.notes }}{% else %}<span class="text-muted">—</span>{% endif %}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center py-5">
        <div class="mb-4">
            <div class="rounded-circle bg-light d-inline-flex align-items-center justify-content-center" style="width: 100px; height: 100px;">
                <i class="fas fa-calendar-times fa-3x text-muted"></i>
            </div>
        </div>
        <h4 class="mb-3">No Attendance Records Found</h4>
        <p class="text-muted mb-4">No attendance records for the selected period.</p>
        <a href="{{ url_for('student_dashboard') }}" class="btn btn-primary px-4">
            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
        </a>
    </div>
    {% endif %}
</div>

<!-- Subject-wise Attendance (if available) -->
{% if subject_attendance %}
<div class="glass-card" data-aos="fade-up">
    <h4 class="mb-4">
        <i class="fas fa-book-open me-2 text-primary"></i>
        Subject-wise Attendance
    </h4>
    <div class="row">
        {% for subject, data in subject_attendance.items() %}
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="p-3 border rounded-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="fw-bold mb-0">{{ subject }}</h6>
                    <span class="badge {% if data.percentage >= 80 %}bg-success{% elif data.percentage >= 60 %}bg-warning{% else %}bg-danger{% endif %}">
                        {{ data.percentage|round|int }}%
                    </span>
                </div>
                <div class="progress" style="height: 4px;">
                    <div class="progress-bar {% if data.percentage >= 80 %}bg-success{% elif data.percentage >= 60 %}bg-warning{% else %}bg-danger{% endif %}" style="width: {{ data.percentage }}%"></div>
                </div>
                <div class="small text-muted mt-2">
                    Present: {{ data.present }}/{{ data.total }} days
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Monthly Summary Pie Chart -->
<div class="glass-card mt-4" data-aos="fade-up">
    <div class="row align-items-center">
        <div class="col-md-6">
            <h4 class="mb-3">
                <i class="fas fa-chart-pie me-2 text-primary"></i>
                Monthly Summary
            </h4>
            <div style="height: 200px; width: 200px; margin: 0 auto;">
                <canvas id="monthlyPieChart"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="list-group list-group-flush">
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-check-circle text-success me-2"></i>Present</span>
                    <span class="fw-bold">{{ attendance_stats.present_days }}</span>
                </div>
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-times-circle text-danger me-2"></i>Absent</span>
                    <span class="fw-bold">{{ attendance_stats.absent_days }}</span>
                </div>
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-clock text-warning me-2"></i>Late</span>
                    <span class="fw-bold">{{ attendance_stats.late_days }}</span>
                </div>
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-hourglass-half text-info me-2"></i>Half Day</span>
                    <span class="fw-bold">{{ attendance_stats.half_days }}</span>
                </div>
                <div class="list-group-item d-flex justify-content-between align-items-center bg-light">
                    <span><i class="fas fa-chart-line text-primary me-2"></i>Total Days</span>
                    <span class="fw-bold">{{ attendance_stats.total_days }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bottom Navigation (mobile only) -->
<nav class="bottom-nav d-lg-none">
    <a href="{{ url_for('student_dashboard') }}" class="bottom-nav-item">
        <i class="fas fa-home"></i>
        <span>Home</span>
    </a>
    <a href="{{ url_for('student_fees') }}" class="bottom-nav-item">
        <i class="fas fa-file-invoice-dollar"></i>
        <span>Fees</span>
    </a>
    <a href="{{ url_for('student_attendance') }}" class="bottom-nav-item active">
        <i class="fas fa-calendar-check"></i>
        <span>Attendance</span>
    </a>
    <a href="{{ url_for('student_profile') }}" class="bottom-nav-item">
        <i class="fas fa-user"></i>
        <span>Profile</span>
    </a>
</nav>

<style>
.glass-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 1.5rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.premium-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
}

.premium-table th {
    background: #f8fafc;
    padding: 1rem;
    font-weight: 600;
    color: #1e293b;
    border-bottom: 2px solid #e2e8f0;
}

.premium-table td {
    padding: 1rem;
    border-bottom: 1px solid #e2e8f0;
    vertical-align: middle;
}

.premium-table tbody tr:hover {
    background: #f8fafc;
}

.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.3rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 500;
}

.status-paid {
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
}

.status-pending {
    background: rgba(245, 158, 11, 0.1);
    color: #f59e0b;
}

.status-overdue {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
}

.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    display: flex;
    justify-content: space-around;
    padding: 0.5rem 1rem calc(0.5rem + var(--safe-bottom));
    box-shadow: 0 -4px 12px rgba(0,0,0,0.05);
    z-index: 1000;
    border-top: 1px solid #e2e8f0;
}
.bottom-nav-item {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    color: #94a3b8;
    font-size: 0.7rem;
    text-decoration: none;
    padding: 0.25rem 0;
}
.bottom-nav-item i { font-size: 1.4rem; margin-bottom: 0.1rem; }
.bottom-nav-item.active { color: #4361ee; }

@media (min-width: 992px) {
    .bottom-nav { display: none; }
}
</style>

<!-- Include FullCalendar -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Attendance trend chart
    const months = {{ months|tojson }};
    const percentages = {{ percentages|tojson }};
    const trendCtx = document.getElementById('attendanceTrendChart').getContext('2d');
    new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: months,
            datasets: [{
                label: 'Attendance %',
                data: percentages,
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#667eea',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 5,
                pointHoverRadius: 7
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: { callbacks: { label: (ctx) => `${ctx.parsed.y}%` } }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: { callback: value => value + '%' }
                }
            }
        }
    });

    // Monthly summary pie chart
    const pieCtx = document.getElementById('monthlyPieChart').getContext('2d');
    new Chart(pieCtx, {
        type: 'doughnut',
        data: {
            labels: ['Present', 'Absent', 'Late', 'Half Day'],
            datasets: [{
                data: [
                    {{ attendance_stats.present_days }},
                    {{ attendance_stats.absent_days }},
                    {{ attendance_stats.late_days }},
                    {{ attendance_stats.half_days }}
                ],
                backgroundColor: ['#10b981', '#ef4444', '#f59e0b', '#0ea5e9'],
                borderWidth: 0
            }]
        },
        options: {
            cutout: '70%',
            plugins: { legend: { display: false } }
        }
    });

    // Calendar toggle
    const calendarEl = document.getElementById('calendar');
    const calendarContainer = document.getElementById('calendarContainer');
    const toggleBtn = document.getElementById('toggleCalendar');
    let calendar = null;

    toggleBtn.addEventListener('click', function() {
        if (calendarContainer.style.display === 'none') {
            calendarContainer.style.display = 'block';
            toggleBtn.innerHTML = '<i class="fas fa-calendar-minus me-2"></i>Hide Calendar';
            if (!calendar) {
                fetch('/student/attendance/calendar-data')
                    .then(res => res.json())
                    .then(events => {
                        calendar = new FullCalendar.Calendar(calendarEl, {
                            initialView: 'dayGridMonth',
                            headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek' },
                            events: events,
                            eventColor: '#667eea',
                            height: 'auto'
                        });
                        calendar.render();
                    });
            }
        } else {
            calendarContainer.style.display = 'none';
            toggleBtn.innerHTML = '<i class="fas fa-calendar-plus me-2"></i>Show Calendar';
        }
    });
});

function filterByMonth(monthValue) {
    const [year, month] = monthValue.split('-');
    const rows = document.querySelectorAll('#attendanceTable tbody tr');
    rows.forEach(row => {
        const rowDate = row.dataset.date; // format YYYY-MM
        if (rowDate === monthValue) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function resetFilter() {
    document.querySelectorAll('#attendanceTable tbody tr').forEach(row => row.style.display = '');
    document.getElementById('monthFilter').value = "{{ date.today().strftime('%Y-%m') }}";
}

function changeChartPeriod(period) {
    // This would fetch new data and update chart
    alert('Change chart period to ' + period);
}
</script>
{% endblock %}
