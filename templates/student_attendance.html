{% extends "base.html" %}

{% block title %}My Attendance · Premium Student Portal{% endblock %}
{% block header %}Attendance Dashboard{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Home</a></th>
<li class="breadcrumb-item"><a href="{{ url_for('student_dashboard') }}">Dashboard</a></th>
<li class="breadcrumb-item active">Attendance</th>
{% endblock %}

{% block actions %}
<div class="btn-group" role="group">
    <button class="btn btn-outline-primary btn-sm" onclick="refreshData()" data-bs-toggle="tooltip" title="Refresh">
        <i class="fas fa-sync-alt"></i>
    </button>
    <button class="btn btn-outline-primary btn-sm" onclick="window.print()" data-bs-toggle="tooltip" title="Print">
        <i class="fas fa-print"></i>
    </button>
</div>
{% endblock %}

{% block content %}
<!-- ==================== MOBILE APP BAR ==================== -->
<div class="mobile-app-bar d-lg-none">
    <div class="d-flex align-items-center justify-content-between p-3">
        <h1 class="h5 mb-0 fw-bold text-dark">Attendance</h1>
        <div>
            <button class="btn btn-sm btn-outline-primary me-1" onclick="refreshData()">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button class="btn btn-sm btn-outline-primary" onclick="window.print()">
                <i class="fas fa-print"></i>
            </button>
        </div>
    </div>
</div>

<!-- ==================== STATS CARDS (Premium Glass) ==================== -->
<div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
        <div class="stat-card glass-card">
            <div class="d-flex align-items-center">
                <div class="stat-icon bg-success-light text-success rounded-circle me-3">
                    <i class="fas fa-user-check fa-lg"></i>
                </div>
                <div>
                    <span class="stat-label text-muted">Present</span>
                    <h3 class="stat-value">{{ attendance_stats.present_days }}</h3>
                    <small class="text-muted">{{ attendance_stats.current_month }}</small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card glass-card">
            <div class="d-flex align-items-center">
                <div class="stat-icon bg-danger-light text-danger rounded-circle me-3">
                    <i class="fas fa-user-times fa-lg"></i>
                </div>
                <div>
                    <span class="stat-label text-muted">Absent</span>
                    <h3 class="stat-value">{{ attendance_stats.absent_days }}</h3>
                    <small class="text-muted">This month</small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card glass-card">
            <div class="d-flex align-items-center">
                <div class="stat-icon bg-warning-light text-warning rounded-circle me-3">
                    <i class="fas fa-clock fa-lg"></i>
                </div>
                <div>
                    <span class="stat-label text-muted">Late</span>
                    <h3 class="stat-value">{{ attendance_stats.late_days }}</h3>
                    <small class="text-muted">This month</small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card glass-card">
            <div class="d-flex align-items-center">
                <div class="stat-icon bg-info-light text-info rounded-circle me-3">
                    <i class="fas fa-hourglass-half fa-lg"></i>
                </div>
                <div>
                    <span class="stat-label text-muted">Half Day</span>
                    <h3 class="stat-value">{{ attendance_stats.half_days }}</h3>
                    <small class="text-muted">This month</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ==================== ATTENDANCE RATE & CLASS COMPARISON ==================== -->
<div class="row g-3 mb-4">
    <div class="col-md-6">
        <div class="premium-card h-100">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0"><i class="fas fa-chart-pie text-primary me-2"></i>Attendance Rate</h5>
                <span class="badge {% if attendance_stats.attendance_percentage >= 80 %}bg-success{% elif attendance_stats.attendance_percentage >= 60 %}bg-warning{% else %}bg-danger{% endif %} fs-6">
                    {{ attendance_stats.attendance_percentage }}%
                </span>
            </div>
            <div class="position-relative" style="height: 180px;">
                <canvas id="attendanceGauge"></canvas>
            </div>
            <div class="row text-center mt-3">
                <div class="col-4">
                    <div class="small text-muted">Total Days</div>
                    <div class="fw-bold">{{ attendance_stats.total_days }}</div>
                </div>
                <div class="col-4">
                    <div class="small text-muted">Present</div>
                    <div class="fw-bold text-success">{{ attendance_stats.present_days }}</div>
                </div>
                <div class="col-4">
                    <div class="small text-muted">Absent</div>
                    <div class="fw-bold text-danger">{{ attendance_stats.absent_days }}</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="premium-card h-100">
            <h5 class="mb-3"><i class="fas fa-chart-line text-primary me-2"></i>vs Class Average</h5>
            <div class="d-flex align-items-center mb-3">
                <div class="flex-grow-1">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="small">Your attendance</span>
                        <span class="fw-bold {% if attendance_stats.attendance_percentage >= class_avg %}text-success{% else %}text-warning{% endif %}">
                            {{ attendance_stats.attendance_percentage }}%
                        </span>
                    </div>
                    <div class="progress mb-2" style="height: 8px;">
                        <div class="progress-bar bg-info" style="width: {{ class_avg }}%" role="progressbar" aria-label="Class average"></div>
                        <div class="progress-bar {% if attendance_stats.attendance_percentage >= class_avg %}bg-success{% else %}bg-warning{% endif %}" 
                             style="width: {{ attendance_stats.attendance_percentage }}%; margin-left: -{{ attendance_stats.attendance_percentage }}%;" 
                             role="progressbar" aria-label="Your attendance"></div>
                    </div>
                    <div class="d-flex justify-content-between small">
                        <span>Class avg: {{ class_avg|round(1) }}%</span>
                        <span>Difference: {{ (attendance_stats.attendance_percentage - class_avg)|round(1) }}%</span>
                    </div>
                </div>
            </div>
            <hr>
            <h6 class="mb-3"><i class="fas fa-calendar-week text-primary me-2"></i>Last 7 Days Trend</h6>
            <div style="height: 100px;">
                <canvas id="weeklyTrend"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- ==================== CALENDAR & FILTERS ==================== -->
<div class="premium-card mb-4">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
        <h5 class="mb-0"><i class="fas fa-calendar-alt text-primary me-2"></i>Attendance Calendar</h5>
        <div class="d-flex gap-2">
            <select class="form-select form-select-sm" id="monthFilter" style="width: auto;" onchange="filterByMonth(this.value)">
                <option value="">All Months</option>
                <option value="{{ date.today().strftime('%Y-%m') }}" selected>Current Month</option>
                <option value="last">Last Month</option>
                <option value="custom">Custom Range...</option>
            </select>
            <div class="btn-group" role="group">
                <button class="btn btn-outline-primary btn-sm" onclick="changeView('dayGridMonth')">Month</button>
                <button class="btn btn-outline-primary btn-sm" onclick="changeView('timeGridWeek')">Week</button>
                <button class="btn btn-outline-primary btn-sm" onclick="changeView('listWeek')">List</button>
            </div>
        </div>
    </div>
    <div id="calendar"></div>
</div>

<!-- ==================== ATTENDANCE HISTORY TABLE ==================== -->
<div class="premium-card">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
        <h5 class="mb-0"><i class="fas fa-history text-primary me-2"></i>Detailed Records</h5>
        <div class="d-flex gap-2">
            <input type="text" class="form-control form-control-sm" id="tableSearch" placeholder="Search date, status..." style="width: 200px;">
            <select class="form-select form-select-sm" id="statusFilter" style="width: 130px;" onchange="filterTable()">
                <option value="all">All Status</option>
                <option value="present">Present</option>
                <option value="absent">Absent</option>
                <option value="late">Late</option>
                <option value="half_day">Half Day</option>
            </select>
        </div>
    </div>
    <div class="table-responsive">
        <table class="premium-table" id="attendanceTable">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Day</th>
                    <th>Status</th>
                    <th>Class</th>
                    <th>Subject</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody>
                {% for record in attendance_records %}
                <tr>
                    <td data-order="{{ record.date.isoformat() }}">{{ record.date.strftime('%d %b %Y') }}</td>
                    <td>{{ record.date.strftime('%A') }}</td>
                    <td>
                        <span class="status-badge status-{{ record.status }}">
                            <i class="fas fa-{% if record.status == 'present' %}check-circle{% elif record.status == 'absent' %}times-circle{% elif record.status == 'late' %}clock{% else %}hourglass-half{% endif %} me-1"></i>
                            {{ record.status|title }}
                        </span>
                    </td>
                    <td>{{ record.class_.name }}</td>
                    <td>{{ record.class_.subject or '—' }}</td>
                    <td>{% if record.notes %}{{ record.notes }}{% else %}<span class="text-muted">—</span>{% endif %}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="text-muted small mt-3 text-center">
        Showing {{ attendance_records|length }} records · Last updated {{ date.today().strftime('%d %b %Y') }}
    </div>
</div>

<!-- ==================== SUBJECT-WISE ATTENDANCE (if available) ==================== -->
{% if subject_attendance %}
<div class="premium-card mt-4">
    <h5 class="mb-3"><i class="fas fa-book-open text-primary me-2"></i>Subject-wise Attendance</h5>
    <div class="row g-3">
        {% for subject, data in subject_attendance.items() %}
        <div class="col-md-6 col-lg-4">
            <div class="subject-card p-3 border rounded-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="fw-bold mb-0">{{ subject }}</h6>
                    <span class="badge {% if data.percentage >= 80 %}bg-success{% elif data.percentage >= 60 %}bg-warning{% else %}bg-danger{% endif %}">
                        {{ data.percentage|round|int }}%
                    </span>
                </div>
                <div class="progress mb-2" style="height: 4px;">
                    <div class="progress-bar {% if data.percentage >= 80 %}bg-success{% elif data.percentage >= 60 %}bg-warning{% else %}bg-danger{% endif %}" 
                         style="width: {{ data.percentage }}%"></div>
                </div>
                <div class="d-flex justify-content-between small text-muted">
                    <span>Present: {{ data.present }}/{{ data.total }}</span>
                    <span>Absent: {{ data.total - data.present }}</span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- ==================== MONTHLY SUMMARY CHART ==================== -->
<div class="premium-card mt-4">
    <h5 class="mb-3"><i class="fas fa-chart-bar text-primary me-2"></i>Monthly Attendance Summary</h5>
    <div class="row align-items-center">
        <div class="col-md-8">
            <div style="height: 250px;">
                <canvas id="monthlyBarChart"></canvas>
            </div>
        </div>
        <div class="col-md-4">
            <div class="list-group list-group-flush">
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-check-circle text-success me-2"></i>Present</span>
                    <span class="fw-bold">{{ attendance_stats.present_days }}</span>
                </div>
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-times-circle text-danger me-2"></i>Absent</span>
                    <span class="fw-bold">{{ attendance_stats.absent_days }}</span>
                </div>
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-clock text-warning me-2"></i>Late</span>
                    <span class="fw-bold">{{ attendance_stats.late_days }}</span>
                </div>
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-hourglass-half text-info me-2"></i>Half Day</span>
                    <span class="fw-bold">{{ attendance_stats.half_days }}</span>
                </div>
                <div class="list-group-item d-flex justify-content-between align-items-center bg-light">
                    <span><i class="fas fa-calendar-alt text-primary me-2"></i>Total Days</span>
                    <span class="fw-bold">{{ attendance_stats.total_days }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ==================== STYLES ==================== -->
<style>
:root {
    --glass-bg: rgba(255, 255, 255, 0.95);
    --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
    --border-light: 1px solid rgba(226, 232, 240, 0.6);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
}
body {
    background-color: #f8fafc;
    padding-bottom: 80px;
}

/* Glass card effect */
.glass-card, .premium-card {
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    border-radius: 24px;
    padding: 1.5rem;
    box-shadow: var(--glass-shadow);
    border: var(--border-light);
    transition: transform 0.2s, box-shadow 0.2s;
}
.premium-card {
    padding: 1.25rem;
}
.glass-card:hover, .premium-card:hover {
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.08);
}

/* Stat cards */
.stat-card {
    background: white;
    border-radius: 20px;
    padding: 1.25rem;
    border: var(--border-light);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.02);
}
.stat-icon {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
}
.stat-value {
    font-size: 1.75rem;
    font-weight: 700;
    line-height: 1.2;
    color: #1e293b;
}
.stat-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Background tints */
.bg-success-light { background: rgba(16, 185, 129, 0.1); }
.bg-danger-light { background: rgba(239, 68, 68, 0.1); }
.bg-warning-light { background: rgba(245, 158, 11, 0.1); }
.bg-info-light { background: rgba(14, 165, 233, 0.1); }

/* Status badges */
.status-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.35rem 0.9rem;
    border-radius: 30px;
    font-size: 0.75rem;
    font-weight: 500;
}
.status-present {
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
    border: 1px solid rgba(16, 185, 129, 0.2);
}
.status-absent {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.2);
}
.status-late {
    background: rgba(245, 158, 11, 0.1);
    color: #f59e0b;
    border: 1px solid rgba(245, 158, 11, 0.2);
}
.status-half_day {
    background: rgba(14, 165, 233, 0.1);
    color: #0ea5e9;
    border: 1px solid rgba(14, 165, 233, 0.2);
}

/* Premium table */
.premium-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
}
.premium-table th {
    background: #f8fafc;
    padding: 1rem 1.25rem;
    font-weight: 600;
    color: #1e293b;
    border-bottom: 2px solid #e2e8f0;
    font-size: 0.875rem;
}
.premium-table td {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid #e2e8f0;
    vertical-align: middle;
}
.premium-table tbody tr:hover {
    background: #f8fafc;
}

/* Mobile adjustments */
.mobile-app-bar {
    background: white;
    border-bottom: 1px solid #e2e8f0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    margin-bottom: 1rem;
    position: sticky;
    top: 0;
    z-index: 900;
    width: 100%;
}
.mobile-app-bar h1 {
    font-size: 1.25rem;
    letter-spacing: 0.3px;
}

/* Subject card */
.subject-card {
    background: white;
    transition: transform 0.2s;
}
.subject-card:active {
    transform: scale(0.98);
}

/* FullCalendar customization */
.fc {
    --fc-border-color: #e2e8f0;
    --fc-button-text-color: #fff;
    --fc-button-bg-color: #4f46e5;
    --fc-button-border-color: #4f46e5;
    --fc-button-hover-bg-color: #4338ca;
    --fc-button-hover-border-color: #4338ca;
    --fc-button-active-bg-color: #3730a3;
}
.fc .fc-toolbar-title {
    font-size: 1.2rem;
    font-weight: 600;
}
.fc-event {
    border: none;
    padding: 2px 4px;
    font-size: 0.8rem;
}

@media (max-width: 768px) {
    .stat-value { font-size: 1.4rem; }
    .stat-icon { width: 40px; height: 40px; font-size: 1rem; }
    .premium-card { padding: 1rem; }
    .fc .fc-toolbar { flex-direction: column; gap: 0.5rem; }
    .fc .fc-toolbar-title { font-size: 1rem; }
}
@media (min-width: 992px) {
    body { padding-bottom: 0; }
}
</style>

<!-- Include FullCalendar & Chart.js -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ========== GAUGE CHART ==========
    const gaugeCtx = document.getElementById('attendanceGauge').getContext('2d');
    new Chart(gaugeCtx, {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [{{ attendance_stats.attendance_percentage }}, 100 - {{ attendance_stats.attendance_percentage }}],
                backgroundColor: ['#10b981', '#e2e8f0'],
                borderWidth: 0,
                circumference: 180,
                rotation: 270
            }]
        },
        options: {
            cutout: '70%',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false }, tooltip: { enabled: false } }
        }
    });

    // ========== WEEKLY TREND (dummy data - replace with real) ==========
    const weeklyCtx = document.getElementById('weeklyTrend').getContext('2d');
    new Chart(weeklyCtx, {
        type: 'line',
        data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
            datasets: [{
                data: [85, 92, 78, 88, 95, 70],
                borderColor: '#4f46e5',
                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#4f46e5',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, max: 100, display: false }, x: { display: true } }
        }
    });

    // ========== MONTHLY BAR CHART ==========
    const barCtx = document.getElementById('monthlyBarChart').getContext('2d');
    new Chart(barCtx, {
        type: 'bar',
        data: {
            labels: {{ months|tojson }},
            datasets: [{
                label: 'Present',
                data: {{ percentages|tojson }},
                backgroundColor: '#10b981',
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } } }
        }
    });

    // ========== FULLCALENDAR ==========
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' },
        events: '/student/attendance/calendar-data',  // endpoint returning JSON events
        eventColor: '#4f46e5',
        height: 'auto',
        eventDidMount: function(info) {
            // Add custom tooltip
            info.el.setAttribute('title', info.event.title);
        }
    });
    calendar.render();
    window.calendar = calendar;  // make accessible globally

    // ========== TABLE SEARCH & FILTER ==========
    const table = document.getElementById('attendanceTable');
    const searchInput = document.getElementById('tableSearch');
    const statusFilter = document.getElementById('statusFilter');

    function filterTable() {
        const searchTerm = searchInput.value.toLowerCase();
        const status = statusFilter.value;
        const rows = table.tBodies[0].rows;
        Array.from(rows).forEach(row => {
            const date = row.cells[0].innerText.toLowerCase();
            const day = row.cells[1].innerText.toLowerCase();
            const statusCell = row.cells[2].innerText.toLowerCase();
            const matchesSearch = date.includes(searchTerm) || day.includes(searchTerm);
            const matchesStatus = status === 'all' || statusCell.includes(status);
            row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
        });
    }

    searchInput.addEventListener('keyup', filterTable);
    statusFilter.addEventListener('change', filterTable);

    // ========== MONTH FILTER (simplified) ==========
    window.filterByMonth = function(monthValue) {
        if (monthValue === 'custom') {
            // Open custom range picker (simplified)
            alert('Custom range coming soon!');
        } else if (monthValue) {
            // Change calendar view to month
            calendar.gotoDate(monthValue + '-01');
        }
    };

    window.changeView = function(view) {
        calendar.changeView(view);
    };
});

function refreshData() {
    location.reload();
}
</script>
{% endblock %}
