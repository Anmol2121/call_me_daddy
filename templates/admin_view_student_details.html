{% extends "base.html" %}
{% block title %}Student Details - {{ student.first_name }} {{ student.last_name }}{% endblock %}
{% block header %}Student Details{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('manage_students') }}">Students</a></li>
<li class="breadcrumb-item active">Details</li>
{% endblock %}

{% block actions %}
<div class="btn-group">
    <a href="{{ url_for('manage_students') }}" class="btn btn-secondary btn-sm">
        <i class="fas fa-arrow-left me-1"></i> Back to Students
    </a>
    <a href="{{ url_for('edit_student', student_id=student.id) }}" class="btn btn-warning btn-sm ms-2">
        <i class="fas fa-edit me-1"></i> Edit
    </a>
    <a href="{{ url_for('reset_student_password', student_id=student.id) }}" class="btn btn-danger btn-sm ms-2">
        <i class="fas fa-key me-1"></i> Reset Password
    </a>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Left Column - Student Information -->
    <div class="col-md-5">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-user-graduate me-2"></i>
                    Student Information
                </h5>
            </div>
            <div class="card-body">
                <div class="text-center mb-4">
                    <div class="avatar-xl bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center">
                        {{ student.first_name[0]|upper }}
                    </div>
                    <h4 class="mt-3">{{ student.first_name }} {{ student.last_name }}</h4>
                    <p class="text-muted">{{ student.student_id }}</p>
                </div>
                
                <div class="list-group list-group-flush">
                    <div class="list-group-item px-0 d-flex justify-content-between">
                        <span>Date of Birth:</span>
                        <strong>{{ student.date_of_birth.strftime('%Y-%m-%d') }}</strong>
                    </div>
                    <div class="list-group-item px-0 d-flex justify-content-between">
                        <span>Gender:</span>
                        <span>{{ student.gender|title }}</span>
                    </div>
                    <div class="list-group-item px-0 d-flex justify-content-between">
                        <span>Phone:</span>
                        <span>{{ student.phone or 'Not provided' }}</span>
                    </div>
                    <div class="list-group-item px-0 d-flex justify-content-between">
                        <span>Email:</span>
                        <span>{{ student.email }}</span>
                    </div>
                    <div class="list-group-item px-0 d-flex justify-content-between">
                        <span>Status:</span>
                        <span class="badge {% if student.is_active %}bg-success{% else %}bg-danger{% endif %}">
                            {{ 'Active' if student.is_active else 'Inactive' }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Parent Information -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-users me-2"></i>
                    Parent Information
                </h5>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    <div class="list-group-item px-0 d-flex justify-content-between">
                        <span>Father's Name:</span>
                        <strong>{{ student.father_name or 'Not provided' }}</strong>
                    </div>
                    <div class="list-group-item px-0 d-flex justify-content-between">
                        <span>Mother's Name:</span>
                        <strong>{{ student.mother_name or 'Not provided' }}</strong>
                    </div>
                    <div class="list-group-item px-0 d-flex justify-content-between">
                        <span>Parent Email:</span>
                        <span>{{ student.parent_email or 'Not provided' }}</span>
                    </div>
                </div>
                
                {% if student.parent_email %}
                <div class="mt-3 d-grid gap-2">
                    <a href="{{ url_for('view_siblings', parent_email=student.parent_email) }}" 
                       class="btn btn-outline-primary">
                        <i class="fas fa-users me-2"></i> View Siblings
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Right Column - Academic Information -->
    <div class="col-md-7">
        <!-- Current Enrollment -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-graduation-cap me-2"></i>
                    Current Enrollment
                </h5>
            </div>
            <div class="card-body">
                {% if current_enrollment %}
                <div class="row">
                    <div class="col-md-6">
                        <h6>Class Information</h6>
                        <p><strong>Class:</strong> {{ current_enrollment.class_.name }}</p>
                        <p><strong>Class Code:</strong> {{ current_enrollment.class_.code }}</p>
                        <p><strong>Room:</strong> {{ current_enrollment.class_.room_number or 'Not assigned' }}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Enrollment Details</h6>
                        <p><strong>Roll Number:</strong> {{ current_enrollment.roll_number }}</p>
                        <p><strong>Enrollment Date:</strong> {{ current_enrollment.enrollment_date.strftime('%Y-%m-%d') }}</p>
                        <p><strong>Session:</strong> {{ current_enrollment.session.name }}</p>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-exclamation-circle fa-2x text-warning mb-3"></i>
                    <p class="text-muted">Student is not enrolled in current session</p>
                    <a href="{{ url_for('enroll_student') }}" class="btn btn-sm btn-primary">
                        <i class="fas fa-user-plus me-1"></i> Enroll Now
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Login Information -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-key me-2"></i>
                    Login Information
                </h5>
            </div>
            <div class="card-body">
                {% if user %}
                <div class="row">
                    <div class="col-md-6">
                        <h6>Account Details</h6>
                        <p><strong>Username:</strong> {{ user.email }}</p>
                        <p><strong>Role:</strong> <span class="badge bg-info">{{ user.role|title }}</span></p>
                        <p><strong>Last Login:</strong> 
                            {% if user.last_login %}
                            {{ user.last_login.strftime('%Y-%m-%d %H:%M') }}
                            {% else %}
                            Never
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <h6>Account Status</h6>
                        <p><strong>Password Status:</strong> 
                            <span class="badge {% if user.must_change_password %}bg-warning{% else %}bg-success{% endif %}">
                                {{ 'Change Required' if user.must_change_password else 'Active' }}
                            </span>
                        </p>
                        <p><strong>Account Created:</strong> {{ user.created_at.strftime('%Y-%m-%d') }}</p>
                        <p><strong>Account Active:</strong> 
                            <span class="badge {% if user.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                {{ 'Yes' if user.is_active else 'No' }}
                            </span>
                        </p>
                    </div>
                </div>
                
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    Student can log in using their email and password to access their dashboard.
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-exclamation-triangle fa-2x text-danger mb-3"></i>
                    <p class="text-danger">No user account found for this student</p>
                    <p class="text-muted">Student cannot log in without a user account</p>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Academic History -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>
                    Academic History
                </h5>
            </div>
            <div class="card-body">
                {% if sessions_data %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Session</th>
                                <th>Class</th>
                                <th>Roll No.</th>
                                <th>Status</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for data in sessions_data %}
                            <tr>
                                <td>{{ data.session.name }}</td>
                                <td>{{ data.class.name }}</td>
                                <td>{{ data.enrollment.roll_number }}</td>
                                <td>
                                    <span class="badge {% if data.enrollment.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                                        {{ 'Active' if data.enrollment.is_active else 'Inactive' }}
                                    </span>
                                </td>
                                <td>{{ data.enrollment.enrollment_date.strftime('%Y-%m-%d') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-3">
                    <p class="text-muted">No academic history available</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}