{% extends "base.html" %}
{% block title %}My Fee Dashboard{% endblock %}
{% block header %}My Fee Dashboard{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('student_dashboard') }}">Dashboard</a></li>
<li class="breadcrumb-item active">Fee Dashboard</li>
{% endblock %}

{% block actions %}
<button onclick="printFeeStatement()" class="btn btn-outline-primary btn-sm me-2">
    <i class="fas fa-print me-1"></i> Print Statement
</button>
<a href="{{ url_for('student_fees') }}" class="btn btn-primary btn-sm">
    <i class="fas fa-list me-1"></i> View All Fees
</a>
{% endblock %}

{% block content %}
<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon stat-icon-primary">
                <i class="fas fa-file-invoice-dollar"></i>
            </div>
            <div>
                <h2 class="stat-number">₹{{ total_due|round|int }}</h2>
                <div class="stat-label">Total Due</div>
                <small class="text-muted">Current Session</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon stat-icon-success">
                <i class="fas fa-check-circle"></i>
            </div>
            <div>
                <h2 class="stat-number">₹{{ total_paid|round|int }}</h2>
                <div class="stat-label">Total Paid</div>
                {% set paid_percentage = (total_paid / total_due * 100) if total_due > 0 else 0 %}
                <small class="text-muted">{{ paid_percentage|round(1) }}% Paid</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon stat-icon-warning">
                <i class="fas fa-clock"></i>
            </div>
            <div>
                <h2 class="stat-number">₹{{ remaining_due|round|int }}</h2>
                <div class="stat-label">Balance Due</div>
                <small class="text-muted">{{ overdue_fees|length }} Overdue</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon stat-icon-info">
                <i class="fas fa-percent"></i>
            </div>
            <div>
                <h2 class="stat-number">{{ total_discount|round|int }}</h2>
                <div class="stat-label">Total Discount</div>
                <small class="text-muted">Scholarships & Concessions</small>
            </div>
        </div>
    </div>
</div>

<!-- Student Information -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Student Information</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3 text-center">
                <div class="avatar-xl bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3">
                    {{ student.first_name[0]|upper }}
                </div>
                <h5>{{ student.first_name }} {{ student.last_name }}</h5>
                <p class="text-muted">{{ student.student_id }}</p>
            </div>
            <div class="col-md-9">
                <div class="row">
                    <div class="col-md-4">
                        <p><strong>Class:</strong> {{ class_info.name if class_info else 'Not Enrolled' }}</p>
                        <p><strong>Roll No:</strong> {{ enrollment.roll_number if enrollment else 'N/A' }}</p>
                    </div>
                    <div class="col-md-4">
                        <p><strong>Session:</strong> {{ current_session.name if current_session else 'No Session' }}</p>
                        <p><strong>Parent:</strong> {{ student.father_name or student.mother_name or 'Not specified' }}</p>
                    </div>
                    <div class="col-md-4">
                        <p><strong>Email:</strong> {{ student.email }}</p>
                        <p><strong>Phone:</strong> {{ student.phone or 'Not provided' }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Fee Overview Charts -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <h6 class="mb-0">Fee Payment Status</h6>
            </div>
            <div class="card-body">
                <div class="position-relative" style="height: 200px;">
                    <canvas id="feeStatusChart"></canvas>
                </div>
                <div class="row mt-3 text-center">
                    <div class="col-4">
                        <div class="p-2 bg-success-light rounded">
                            <div class="text-success fw-bold">{{ fees|selectattr('status', 'equalto', 'paid')|list|length }}</div>
                            <small class="text-muted">Paid</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="p-2 bg-warning-light rounded">
                            <div class="text-warning fw-bold">{{ fees|selectattr('status', 'equalto', 'partial')|list|length }}</div>
                            <small class="text-muted">Partial</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="p-2 bg-danger-light rounded">
                            <div class="text-danger fw-bold">{{ fees|selectattr('status', 'equalto', 'pending')|list|length }}</div>
                            <small class="text-muted">Pending</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <h6 class="mb-0">Payment Progress</h6>
            </div>
            <div class="card-body">
                <div class="text-center mb-4">
                    <div class="position-relative d-inline-block">
                        <canvas id="paymentProgress" width="150" height="150"></canvas>
                        <div class="position-absolute top-50 start-50 translate-middle">
                            <h3 class="mb-0">
                                {% if total_due > 0 %}
                                    {{ ((total_paid / total_due) * 100)|round|int }}%
                                {% else %}
                                    100%
                                {% endif %}
                            </h3>
                            <small class="text-muted">Paid</small>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span>Total Fees:</span>
                        <span>₹{{ total_due|round|int }}</span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-success" 
                             style="width: {% if total_due > 0 %}{{ (total_paid / total_due * 100)|round|int }}{% else %}100{% endif %}%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Fee Breakdown -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Fee Breakdown - {{ current_session.name if current_session else 'Current Session' }}</h5>
    </div>
    <div class="card-body">
        {% if fees %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Fee Type</th>
                        <th>Due Date</th>
                        <th>Original</th>
                        <th>Discount</th>
                        <th>Fine</th>
                        <th>Net Amount</th>
                        <th>Paid</th>
                        <th>Balance</th>
                        <th>Status</th>
                        <th>Receipt</th>
                    </tr>
                </thead>
                <tbody>
                    {% for fee in fees %}
                    <tr>
                        <td>{{ fee.fee_structure.name }}</td>
                        <td>
                            {{ fee.due_date.strftime('%d %b %Y') }}
                            {% if fee.due_date < date.today() and fee.status in ['pending', 'partial'] %}
                            <span class="badge bg-danger ms-1">Overdue</span>
                            {% endif %}
                        </td>
                        <td>₹{{ fee.fee_amount }}</td>
                        <td class="text-danger">-₹{{ fee.discount_amount }}</td>
                        <td class="text-warning">+₹{{ fee.fine_amount }}</td>
                        <td><strong>₹{{ fee.fee_amount - fee.discount_amount + fee.fine_amount }}</strong></td>
                        <td class="text-success">₹{{ fee.paid_amount }}</td>
                        <td>
                            {% set balance = fee.fee_amount - fee.discount_amount + fee.fine_amount - fee.paid_amount %}
                            {% if balance > 0 %}
                            <strong class="text-danger">₹{{ balance }}</strong>
                            {% else %}
                            <span class="text-success">₹0</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if fee.status == 'paid' %}
                            <span class="badge bg-success">Paid</span>
                            {% elif fee.status == 'partial' %}
                            <span class="badge bg-warning">Partial</span>
                            {% elif fee.status == 'overdue' %}
                            <span class="badge bg-danger">Overdue</span>
                            {% else %}
                            <span class="badge bg-secondary">Pending</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if fee.transactions %}
                            <a href="{{ url_for('generate_fee_receipt', transaction_id=fee.transactions[0].id) }}" 
                               class="btn btn-sm btn-outline-success" title="View Receipt">
                                <i class="fas fa-receipt"></i>
                            </a>
                            {% else %}
                            <span class="text-muted">No receipt</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-dark">
                    <tr>
                        <td colspan="2"><strong>Totals:</strong></td>
                        <td><strong>₹{{ total_due|round|int }}</strong></td>
                        <td class="text-danger"><strong>-₹{{ total_discount|round|int }}</strong></td>
                        <td class="text-warning"><strong>+₹{{ total_fine|round|int }}</strong></td>
                        <td><strong>₹{{ (total_due - total_discount + total_fine)|round|int }}</strong></td>
                        <td class="text-success"><strong>₹{{ total_paid|round|int }}</strong></td>
                        <td class="{% if remaining_due > 0 %}text-danger{% else %}text-success{% endif %}">
                            <strong>₹{{ remaining_due|round|int }}</strong>
                        </td>
                        <td colspan="2"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-money-bill-wave fa-3x text-muted mb-3"></i>
            <h4>No Fee Records Found</h4>
            <p class="text-muted">No fees have been assigned for this session.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Recent Transactions -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">Recent Payment Transactions</h5>
    </div>
    <div class="card-body">
        {% if recent_transactions %}
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Receipt No.</th>
                        <th>Fee Type</th>
                        <th>Amount</th>
                        <th>Method</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for transaction in recent_transactions %}
                    <tr>
                        <td>{{ transaction.transaction_date.strftime('%d %b %Y') }}</td>
                        <td>
                            <a href="{{ url_for('generate_fee_receipt', transaction_id=transaction.id) }}" 
                               class="text-decoration-none">
                                {{ transaction.receipt_number }}
                            </a>
                        </td>
                        <td>
                            {% if transaction.student_fee %}
                                {{ transaction.student_fee.fee_structure.name }}
                            {% else %}
                                General Payment
                            {% endif %}
                        </td>
                        <td class="text-success">₹{{ transaction.amount }}</td>
                        <td>
                            <span class="badge bg-info">{{ transaction.payment_method|title }}</span>
                        </td>
                        <td>
                            {% if transaction.status == 'success' %}
                            <span class="badge bg-success">Success</span>
                            {% else %}
                            <span class="badge bg-warning">{{ transaction.status|title }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-exchange-alt fa-2x text-muted mb-3"></i>
            <p class="text-muted">No payment transactions found.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Payment Instructions -->
<div class="card mt-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Payment Instructions</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <div class="text-center p-3">
                    <div class="bg-primary-light text-primary rounded-circle d-inline-flex align-items-center justify-content-center mb-3" 
                         style="width: 60px; height: 60px;">
                        <i class="fas fa-university fa-2x"></i>
                    </div>
                    <h6>Bank Transfer</h6>
                    <p class="small text-muted">Transfer to school account</p>
                    <small class="text-muted">Account: XXXX-XXXX-XXXX</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center p-3">
                    <div class="bg-success-light text-success rounded-circle d-inline-flex align-items-center justify-content-center mb-3" 
                         style="width: 60px; height: 60px;">
                        <i class="fas fa-money-bill-wave fa-2x"></i>
                    </div>
                    <h6>Cash Payment</h6>
                    <p class="small text-muted">Pay at school office</p>
                    <small class="text-muted">9:00 AM - 4:00 PM</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center p-3">
                    <div class="bg-info-light text-info rounded-circle d-inline-flex align-items-center justify-content-center mb-3" 
                         style="width: 60px; height: 60px;">
                        <i class="fas fa-credit-card fa-2x"></i>
                    </div>
                    <h6>Online Payment</h6>
                    <p class="small text-muted">Pay via payment gateway</p>
                    <small class="text-muted">Coming Soon</small>
                </div>
            </div>
        </div>
        <div class="alert alert-info mt-3">
            <i class="fas fa-phone me-2"></i>
            <strong>Contact:</strong> For any fee related queries, please contact the school accounts department at 
            <strong>accounts@{{ student.school.email.split('@')[1] if student.school.email and '@' in student.school.email else 'school.com' }}</strong> 
            or call <strong>{{ student.school.phone or 'school office' }}</strong>.
        </div>
    </div>
</div>

<style>
.stat-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1rem;
    font-size: 1.5rem;
}

.stat-icon-primary {
    background-color: rgba(67, 97, 238, 0.1);
    color: #4361ee;
}

.stat-icon-success {
    background-color: rgba(40, 167, 69, 0.1);
    color: #28a745;
}

.stat-icon-warning {
    background-color: rgba(255, 193, 7, 0.1);
    color: #ffc107;
}

.stat-icon-info {
    background-color: rgba(23, 162, 184, 0.1);
    color: #17a2b8;
}

.stat-number {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
    color: #1e293b;
}

.stat-label {
    font-size: 0.875rem;
    color: #64748b;
    font-weight: 500;
}

.avatar-xl {
    width: 80px;
    height: 80px;
    font-size: 2rem;
}

.bg-primary-light {
    background-color: rgba(67, 97, 238, 0.1) !important;
}

.bg-success-light {
    background-color: rgba(40, 167, 69, 0.1) !important;
}

.bg-warning-light {
    background-color: rgba(255, 193, 7, 0.1) !important;
}

.bg-danger-light {
    background-color: rgba(220, 53, 69, 0.1) !important;
}

.bg-info-light {
    background-color: rgba(23, 162, 184, 0.1) !important;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Fee Status Chart
    const statusCtx = document.getElementById('feeStatusChart').getContext('2d');
    const paidCount = {{ fees|selectattr('status', 'equalto', 'paid')|list|length }};
    const partialCount = {{ fees|selectattr('status', 'equalto', 'partial')|list|length }};
    const pendingCount = {{ fees|selectattr('status', 'equalto', 'pending')|list|length }};
    const overdueCount = {{ overdue_fees|length }};
    
    new Chart(statusCtx, {
        type: 'pie',
        data: {
            labels: ['Paid', 'Partial', 'Pending', 'Overdue'],
            datasets: [{
                data: [paidCount, partialCount, pendingCount, overdueCount],
                backgroundColor: [
                    'rgba(40, 167, 69, 0.8)',
                    'rgba(255, 193, 7, 0.8)',
                    'rgba(108, 117, 125, 0.8)',
                    'rgba(220, 53, 69, 0.8)'
                ],
                borderColor: [
                    'rgba(40, 167, 69, 1)',
                    'rgba(255, 193, 7, 1)',
                    'rgba(108, 117, 125, 1)',
                    'rgba(220, 53, 69, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        padding: 20
                    }
                }
            }
        }
    });
    
    // Payment Progress Gauge
    const progressCtx = document.getElementById('paymentProgress').getContext('2d');
    const paidPercentage = {% if total_due > 0 %}{{ (total_paid / total_due * 100)|round|int }}{% else %}100{% endif %};
    
    new Chart(progressCtx, {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [paidPercentage, 100 - paidPercentage],
                backgroundColor: [
                    'rgba(40, 167, 69, 0.8)',
                    'rgba(233, 236, 239, 0.8)'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: false,
            circumference: 180,
            rotation: 270,
            cutout: '70%',
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    enabled: false
                }
            }
        }
    });
});

function printFeeStatement() {
    const printContent = document.querySelector('.card').outerHTML;
    const originalContent = document.body.innerHTML;
    
    document.body.innerHTML = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Fee Statement - {{ student.first_name }} {{ student.last_name }}</title>
            <style>
                body { font-family: Arial, sans-serif; }
                .table { width: 100%; border-collapse: collapse; }
                .table th, .table td { border: 1px solid #ddd; padding: 8px; }
                .table th { background-color: #f8f9fa; }
                .text-success { color: #28a745; }
                .text-danger { color: #dc3545; }
                .text-warning { color: #ffc107; }
                .text-center { text-align: center; }
                .mb-3 { margin-bottom: 1rem; }
            </style>
        </head>
        <body>
            <h1>Fee Statement</h1>
            <h2>{{ student.first_name }} {{ student.last_name }}</h2>
            <p><strong>Student ID:</strong> {{ student.student_id }}</p>
            <p><strong>Class:</strong> {{ class_info.name if class_info else 'Not Enrolled' }}</p>
            <p><strong>Session:</strong> {{ current_session.name if current_session else 'No Session' }}</p>
            <p><strong>Generated:</strong> ${new Date().toLocaleDateString()}</p>
            ${printContent}
        </body>
        </html>
    `;
    
    window.print();
    document.body.innerHTML = originalContent;
    location.reload();
}
</script>
{% endblock %}